name: plancosts-diff

on:
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "plancosts/**"
      - "examples/terraform_0_13/plan.json"
      - "main.py"
      - ".github/workflows/plancosts-diff.yml"

permissions:
  contents: read
  pull-requests: write

env:
  TERRAFORM_DIR: examples/terraform_0_13
  PLANCOSTS_API_URL: http://127.0.0.1:4000

jobs:
  cost-diff:
    runs-on: ubuntu-latest

    steps:
      # --- Check out MAIN and PR into different folders ---
      - name: Checkout base (MAIN)
        uses: actions/checkout@v4
        with:
          ref: refs/heads/main
          path: base
          fetch-depth: 0

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr
          fetch-depth: 0

      # --- Start mock pricing API from the PR tree ---
      - name: Set up Python (for mock server)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps in PR tree (for mock server)
        shell: bash
        working-directory: pr
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [[ -f pyproject.toml ]]; then
            pip install -e .
          elif [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install pytest
          fi

      - name: Start mock pricing API (accessible from Docker)
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
          PYTHONPATH: ${{ github.workspace }}/pr:${{ github.workspace }}/pr/plancosts
        run: |
          set -euxo pipefail
          cd pr
          # Bind to 0.0.0.0 so Docker containers can reach it via host.docker.internal
          nohup python plancosts/plancosts/tests/mock_price.py > ../mock_server.log 2>&1 &
          echo $! > ../mock_pid.txt
          sleep 2
          kill -0 "$(cat ../mock_pid.txt)"

      - name: Wait for mock API readiness
        shell: bash
        run: |
          set -euxo pipefail
          for i in {1..60}; do
            code="$(curl -s -o /dev/null -w '%{http_code}' -X POST "${PLANCOSTS_API_URL}/graphql" || true)"
            [[ "$code" = "200" ]] && echo "Mock API ready" && exit 0
            sleep 0.5
          done
          echo "Mock not ready. Log tail:"; tail -n 200 mock_server.log || true
          exit 1

      # --- Verify Terraform directories ---
      - name: Verify Terraform directories
        run: |
          echo "BASE dir: ${{ github.workspace }}/base/${{ env.TERRAFORM_DIR }}"
          ls -la "${{ github.workspace }}/base/${{ env.TERRAFORM_DIR }}" || true
          echo "PR dir: ${{ github.workspace }}/pr/${{ env.TERRAFORM_DIR }}"
          ls -la "${{ github.workspace }}/pr/${{ env.TERRAFORM_DIR }}" || true

      # --- Run plancosts on MAIN tree (base) via Docker action ---
      - name: Run plancosts (BASE) via Docker action
        id: base
        uses: nikhilamalajerrin/james-tf-action/.github/actions/plancosts@v0.1.16
        with:
          file_prefix: base
          terraform_dir: ${{ github.workspace }}/base/${{ env.TERRAFORM_DIR }}
          api_url: http://host.docker.internal:4000
        env:
          # Ensure the Docker container can reach the host API
          USE_TFDIR: "1"  # Enable real Terraform execution if supported

      # --- Run plancosts on PR tree via Docker action ---
      - name: Run plancosts (PR) via Docker action
        id: prrun
        uses: nikhilamalajerrin/james-tf-action/.github/actions/plancosts@v0.1.16
        with:
          file_prefix: pr
          terraform_dir: ${{ github.workspace }}/pr/${{ env.TERRAFORM_DIR }}
          api_url: http://host.docker.internal:4000
        env:
          # Ensure the Docker container can reach the host API
          USE_TFDIR: "1"  # Enable real Terraform execution if supported

      # --- Verify outputs were created ---
      - name: Verify plancosts outputs
        run: |
          echo "=== Checking for output files ==="
          ls -la base-plancosts.txt pr-plancosts.txt || true
          
          if [[ -f base-plancosts.txt ]]; then
            echo "=== BASE OUTPUT ==="
            cat base-plancosts.txt
          else
            echo "ERROR: base-plancosts.txt not found"
          fi
          
          if [[ -f pr-plancosts.txt ]]; then
            echo "=== PR OUTPUT ==="
            cat pr-plancosts.txt
          else
            echo "ERROR: pr-plancosts.txt not found"
          fi

      # --- Create diff + totals ---
      - name: Create diff
        shell: bash
        run: |
          set -euxo pipefail
          BASE_TXT="base-plancosts.txt"
          PR_TXT="pr-plancosts.txt"
          
          if [[ ! -f "$BASE_TXT" ]]; then
            echo "ERROR: Missing $BASE_TXT"
            echo "0.00" > base-total.txt
          else
            awk '/^OVERALL TOTAL/ {print $NF; exit}' "$BASE_TXT" > base-total.txt || echo "0.00" > base-total.txt
          fi
          
          if [[ ! -f "$PR_TXT" ]]; then
            echo "ERROR: Missing $PR_TXT"
            echo "0.00" > pr-total.txt
          else
            awk '/^OVERALL TOTAL/ {print $NF; exit}' "$PR_TXT" > pr-total.txt || echo "0.00" > pr-total.txt
          fi

          base_total="$(cat base-total.txt)"
          pr_total="$(cat pr-total.txt)"
          
          echo "Base total: $base_total"
          echo "PR total: $pr_total"
          
          # Create diff only if both files exist
          if [[ -f "$BASE_TXT" && -f "$PR_TXT" ]]; then
            diff -u "$BASE_TXT" "$PR_TXT" | tail -n +3 > diff.txt || true
          else
            echo "Cannot create diff - missing output files" > diff.txt
          fi

      # --- Enhanced networking diagnostics ---
      - name: Network diagnostics (for debugging)
        if: always()
        run: |
          echo "=== Network Diagnostics ==="
          echo "Default gateway:"
          ip route | grep default || true
          echo "Docker bridge network:"
          ip addr show docker0 2>/dev/null || echo "No docker0 interface"
          echo "Testing API connectivity from host:"
          curl -s http://127.0.0.1:4000/graphql -X POST || echo "Host API unreachable"
          echo "Testing via host.docker.internal simulation:"
          # This simulates what Docker containers try to reach
          GATEWAY_IP=$(ip route | awk '/default/ {print $3; exit}')
          curl -s http://${GATEWAY_IP}:4000/graphql -X POST || echo "Gateway API unreachable"

      # --- PR comment (Infracost-style) ---
      - name: Comment with cost diff (Infracost-style)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_NAME: ${{ github.repository }} / ${{ env.TERRAFORM_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          
          old="$(cat base-total.txt 2>/dev/null || echo "0.00")"
          new="$(cat pr-total.txt 2>/dev/null || echo "0.00")"
          f_old="$(awk -v n="$old" 'BEGIN{printf "%.2f", n+0}')"
          f_new="$(awk -v n="$new" 'BEGIN{printf "%.2f", n+0}')"
          diff_amt="$(awk -v o="$old" -v n="$new" 'BEGIN{printf "%.2f", (n+0)-(o+0)}')"
          sign="$(awk -v d="$diff_amt" 'BEGIN{ if (d+0>0) print "+"; else if (d+0<0) print "âˆ’"; else print "" }')"
          pct_text="$(awk -v o="$old" -v n="$new" 'BEGIN{
            o+=0; n+=0;
            if (o==0 && n==0) { printf "(+0.00%%)"; exit }
            if (o==0 && n>0)  { printf "(new)";    exit }
            if (o==0 && n<0)  { printf "(n/a)";    exit }
            pct = (n-o)/o*100.0; printf "(%+0.2f%%%%)", pct
          }')"
          diff_cell="${sign}\$${diff_amt} ${pct_text}"
          headline="$(awk -v d="$diff_amt" 'BEGIN{ d+=0; if (d>0) print "increase"; else if (d<0) print "decrease"; else print "stay the same"; }')"

          diff_content="$(cat diff.txt 2>/dev/null || echo "No differences detected")"
          
          echo "DEBUG: Calculated values:"
          echo "  old=$old, new=$new, diff_amt=$diff_amt"
          echo "  headline=$headline, diff_cell=$diff_cell"

          body="$(jq -n --arg headline "$headline" \
                       --arg f_old "$f_old" \
                       --arg f_new "$f_new" \
                       --arg diff_cell "$diff_cell" \
                       --arg proj "${PROJECT_NAME:-project}" \
                       --arg diff "$diff_content" \
            '
            {
              body:
              ("ðŸ’° **Plancosts estimate:** monthly cost will " + $headline + " " +
               "($" + ( ($diff_cell | capture("(?<sign>[+âˆ’-]?)(?<val>[0-9.]+)")).val ) + ") ðŸ“Š\n\n" +
               "| Project | Previous | New | Diff |\n" +
               "|---|---:|---:|---:|\n" +
               "| " + $proj + " | $" + $f_old + " | $" + $f_new + " | " + $diff_cell + " |\n" +
               "| **All projects** | **$" + $f_old + "** | **$" + $f_new + "** | **" + $diff_cell + "** |\n\n" +
               "<details><summary>ðŸ“Š **Detailed plancosts diff**</summary>\n\n```diff\n" +
               $diff + "\n```\n</details>\n")
            }')"

          curl -sS -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "$body"

      - name: Show mock log tail (if present)
        if: always()
        run: |
          if [[ -f mock_server.log ]]; then
            echo "--- mock_server.log (tail) ---"
            tail -n 200 mock_server.log || true
          fi